name: Build (Windows)

on:
  # NOTES: Run CI on pushes, PRs, and manual trigger
  push:
    branches: [ "master", "main" ]
  pull_request:
    branches: [ "master", "main" ]
  workflow_dispatch:

jobs:
  build:
    # NOTES: Safety guard if this repo is forked elsewhere
    if: github.repository_owner == 'SAM-BIM'
    runs-on: windows-2022

    env:
      # NOTES: Prevent MSBuild reusing nodes (fixes random CI hangs)
      MSBUILDDISABLENODEREUSE: "1"

      # NOTES: GitHub organisation and repo name
      ORG_NAME: "SAM-BIM"
      REPO_NAME: "SAM_OpenStudio"

    steps:
      - name: Checkout this repo
        # NOTES: Check out the main repository into a named folder
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          path: ${{ env.REPO_NAME }}

      - name: Setup .NET
        # NOTES: Needed for restore, even though we use msbuild
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.x"

      - name: Setup MSBuild
        # NOTES: Makes `msbuild` available on the runner
        uses: microsoft/setup-msbuild@v2

      - name: Clone dependency repos
        shell: pwsh
        run: |
          # NOTES: Stop immediately on first error
          $ErrorActionPreference = 'Stop'

          # NOTES: Short aliases
          $org  = "${{ env.ORG_NAME }}"
          $repo = "${{ env.REPO_NAME }}"

          # NOTES: Build order is IMPORTANT
          # - SAM → base types (Any CPU)
          # - SAM_SQLite → x64
          # - SAM_OpenStudio → x64 (OpenStudio requires this)
          # - $repo → current repo (x64)
          $buildOrder = @(
            'SAM'
            'SAM_SQLite'
            'SAM_OpenStudio'
            $repo
          )

          # NOTES: Clone everything except the last repo
          $deps = $buildOrder[0..($buildOrder.Count-2)]
          foreach ($r in $deps) {
            if (Test-Path $r) { continue }
            git clone --depth 1 "https://github.com/$org/$r.git" $r
          }

          # NOTES: Some projects expect this path to exist
          New-Item -ItemType Directory -Force -Path "SAM_Windows\build" | Out-Null

      - name: Restore + Rebuild (per-solution platform)
        shell: pwsh
        run: |
          # NOTES: Fail fast
          $ErrorActionPreference = 'Stop'

          # NOTES: Native DLL drop location used by projects
          $windowsRef = (Resolve-Path 'SAM_Windows\build').Path

          # NOTES:
          # This function builds ONE solution with ONE platform
          # Platform MUST match what the .sln actually defines
          function Build-Sln($sln, $platform) {

            Write-Host "==> Restore ($platform): $sln"
            msbuild $sln /t:Restore `
              /m:1 /nr:false /v:m `
              /p:Configuration=Release `
              /p:Platform="$platform" `
              /p:UseSharedCompilation=false `
              /p:RunPostBuildEvent=OnOutputUpdated `
              "/p:ReferencePath=$windowsRef"

            Write-Host "==> Rebuild ($platform): $sln"
            msbuild $sln /t:Rebuild `
              /m:1 /nr:false /v:m `
              /p:Configuration=Release `
              /p:Platform="$platform" `
              /p:UseSharedCompilation=false `
              /p:RunPostBuildEvent=OnOutputUpdated `
              "/p:ReferencePath=$windowsRef"
          }

          # NOTES:
          # Platform mapping is CRITICAL
          # SAM           → Any CPU only
          # OpenStudio    → x64 only
          Build-Sln "SAM\SAM.sln" "Any CPU"
          Build-Sln "SAM_SQLite\SAM_SQLite.sln" "x64"
          Build-Sln "SAM_OpenStudio\SAM_OpenStudio.sln" "x64"
          Build-Sln "${{ env.REPO_NAME }}\${{ env.REPO_NAME }}.sln" "x64"

      - name: Upload build folders (optional)
        # NOTES: Useful for debugging CI artifacts
        uses: actions/upload-artifact@v4
        with:
          name: SAM_OpenStudio-build
          path: |
            **\build\*
          if-no-files-found: warn
