name: Build (Windows)

on:
  push:
    branches: [ "master", "main" ]
  pull_request:
    branches: [ "master", "main" ]
  workflow_dispatch:

jobs:
  build:
    # Guard: if this ever gets merged upstream, it will "skip" there.
    if: github.repository_owner == 'SAM-BIM'
    runs-on: windows-2022

    env:
      MSBUILDDISABLENODEREUSE: "1"
      ORG_NAME: "SAM-BIM"
      REPO_NAME: "SAM_OpenStudio"

    steps:
      - name: Checkout this repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          path: ${{ env.REPO_NAME }}

      - name: Setup .NET 8
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.x"

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Clone dependency repos (siblings)
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'

          $org  = '${{ env.ORG_NAME }}'
          $repo = '${{ env.REPO_NAME }}'

          # Build order: deps first, current repo LAST
          $buildOrder = @(
            'SAM'
            'SAM_SQLite'
            'SAM_OpenStudio'
            $repo
          )

          # Clone deps (everything except current repo which Actions already checked out)
          foreach ($r in $buildOrder) {
            if ($r -eq $repo) { continue }
            if (Test-Path $r) { continue }
            Write-Host "Cloning https://github.com/$org/$r.git"
            git clone --depth 1 "https://github.com/$org/$r.git" $r
          }

      - name: Restore + Rebuild in order (CI props like SAM_Deploy)
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'

          $repo = '${{ env.REPO_NAME }}'

          # Common MSBuild args (ARRAY â€” do not join into one string)
          $common = @(
            '/m:1'
            '/nr:false'
            '/v:m'
            '/p:Configuration=Release'
            '/p:UseSharedCompilation=false'
            '/p:RunPostBuildEvent=OnOutputUpdated'
          )

          # Build order: deps first, current repo LAST
          $buildOrder = @(
            'SAM'
            'SAM_SQLite'
            'SAM_OpenStudio'
            $repo
          )

          # OPTIONAL platform overrides (default is Any CPU).
          # Only set x64 if that solution actually has an x64 platform in Configuration Manager.
          $platformByRepo = @{
            'SAM_SQLite'= 'x64'
            'SAM_OpenStudio'= 'x64'
            # 'SAM_SQLite' = 'x64'
            # $repo        = 'x64'
          }

          function Get-PlatformArg([string]$repoName) {
            $p = 'Any CPU'
            if ($platformByRepo.ContainsKey($repoName)) { $p = $platformByRepo[$repoName] }

            if ($p -match '\s') { return "/p:Platform=`"$p`"" }
            return "/p:Platform=$p"
          }

          function Find-Solution([string]$repoName) {
            $expected = Join-Path $repoName "$repoName.sln"
            if (Test-Path $expected) { return (Resolve-Path $expected).Path }

            $rootSln = Get-ChildItem -Path $repoName -Filter *.sln -File -ErrorAction SilentlyContinue | Select-Object -First 1
            if ($rootSln) { return $rootSln.FullName }

            $anySln = Get-ChildItem -Path $repoName -Recurse -Filter *.sln -File -ErrorAction SilentlyContinue |
                      Where-Object { $_.FullName -notmatch '\\(bin|obj|packages)\\' } |
                      Select-Object -First 1
            if ($anySln) { return $anySln.FullName }

            throw "No .sln found under: $repoName"
          }

          $solutionItems = foreach ($r in $buildOrder) {
            $slnPath = Find-Solution $r
            [pscustomobject]@{ Repo = $r; Sln = $slnPath }
          }

          foreach ($it in $solutionItems) {
            $platArg = Get-PlatformArg $it.Repo
            Write-Host "==> Restore: $($it.Sln) (Repo=$($it.Repo), Platform=$platArg)"
            & msbuild $it.Sln /t:Restore @common $platArg
            if ($LASTEXITCODE -ne 0) { throw "Restore failed: $($it.Repo)" }
          }

          foreach ($it in $solutionItems) {
            $platArg = Get-PlatformArg $it.Repo
            Write-Host "==> Rebuild: $($it.Sln) (Repo=$($it.Repo), Platform=$platArg)"
            & msbuild $it.Sln /t:Rebuild @common $platArg
            if ($LASTEXITCODE -ne 0) { throw "Rebuild failed: $($it.Repo)" }
          }

      - name: Upload build folders (optional)
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.REPO_NAME }}-build-folders
          path: |
            **\build\*
          if-no-files-found: warn
